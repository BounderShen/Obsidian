### VM概述
### VM系统
1. 如何得到PPN
#### address space
1. 线性地址空间使用的是非负整数
2. 虚拟地址空间大于物理地址空间
##### 为什么使用虚拟内存
1. 虚拟内存是存储在磁盘上的数据的DRAM缓存，提高主存效率
2. 简化内存管理
3. 隔离地址空间
	1. 一个进程不能访问、接触另一个的内存
	2. 用户程序不能访问内核和代码
#### VM as a tool for caching 
1. 虚拟内存的空间大多数是未分配的：通过动态地分配和释放内存，可以有效地减少内存的浪费，可以更好的满足进程的需求
2. 虚拟地址包含了所有可能需要的内存地址，包括进程代码、全局变量、堆、栈，但只有小部分实际上被分配到了物理地址
3. 当一个进程访问未分配的虚拟地址空间会发生
##### DRAM Cache Organization
1. 缓存未命中的代价很大
2. 块/页大小：一般是4KB，有时是4MB
3. 全相联：任何一个虚拟可以替代物理页面，需要一个与缓存内存不同的巨大的映射函数
4. 过于复杂、开放、昂贵难以在硬件上实现
5. 采用写回而不是直写
##### 数据结构：页表
1. 页表是一组页表项，将虚拟页面映射到物理页面
2. 内存中每个进程的内核数据结构
##### 页面命中/不命中
1. 引用在不在内存上
##### 处理页面错误也就是缓存未命中
1. 从物理内存中选中一个，踢出去，一般用专门的替代策略算法
2. 从磁盘上复制一份到物理内存上
3. 重新执行指令
4. 直到未命中才将页面复制到内存上，这是请求分页
##### 局部性原理
1. 虚拟内存看起来是不高效，但是因为局部性可以工作
2. 在任何时间点，程序倾向访问一组称为工作集的活动虚拟页面
3. 活动页面少于内存空间：具有很好的性能，在强制未命中后
4. 活动页面大于内存空间：性能崩溃，页面被不断地交换
#### Vm as a tool for memory management
1. 每个进程都有独立的虚拟地址空间
2. 映射函数将地址分散到物理空间中
	1. 一个好的选择映射函数可以提高局部性
***简化内存分配***
1. 一个虚拟页面可以在不同的时间存储在不同的物理页面
***进程之间共享代码和数据***
1. 将虚拟页面映射到同一个物理页面
##### 简化链接和加载
***链接***
1. 每个进程有相似的地址空间
2. 代码，数据，堆都是从一样的地址开始
***加载***
1. `.text` 和 `.data` 部分会被虚拟内存系统按需逐页地复制。
2. `execve` 为 `.text` 和 `.data` 部分分配虚拟页面，并创建被标记为无效的页表项（PTEs）。

#### VM as tool for memory protection
1. 扩展权限位
2. MMU在每次访问上检查这些位
#### Address translation
##### 地址转换：页面命中
1. 处理器发送虚拟地址给MMU
2. MMU从内存中的页表抓取PTE
3. MMU发送物理地址给缓存/内存
4. 内存发送数据给处理器
##### 地址转换：未命中
1. 检测到有效位是0,触发异常
2. 处理受害者，如果是脏页面，则将页面调出到磁盘上。脏页面指的是修改过后的，操作系统会自动标识
3. 在新页面中处理页面，并更新内存中的页表项（PTE）。
4. 处理程序返回到原始进程，重新启动故障指令的执行。
##### 使用TLB加速地址转换
***页表项***
1. PTEs可能被其他引用替代
2. PTE命中仍然需要小L1延迟
***解决方案***
1. MMU 中的小型集合关联硬件缓存
2. 将虚拟页面映射到物理页面
3. 包含小部分页面的完整页表项
##### 为什么TLB未命中率低
1. 大小
2. 缓存替代策略
3. 页面大小

